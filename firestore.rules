rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNGSI BANTUAN UTAMA ---
    
    function isSuperAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    function isStoreAdmin(storeId) {
      return request.auth != null && request.auth.uid in get(/databases/$(database)/documents/stores/$(storeId)).data.adminUids;
    }

    function isStoreMember(storeId) {
        // A user is a member if they are a superadmin, a store admin, or their user document points to that storeId.
        return request.auth != null && (
            isSuperAdmin() ||
            isStoreAdmin(storeId) ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.storeId == storeId
        );
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    // --- ATURAN GLOBAL ---

    match /appSettings/{setting} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    match /platform/stats {
        allow read: if isSuperAdmin();
        allow write: if false; 
    }

    match /redemptionOptions/{optionId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    match /pendingOrders/{orderId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        // Allow update/delete only if the user is a member of the store the order belongs to.
        allow update, delete: if isStoreMember(resource.data.storeId);
    }

    // --- ATURAN PENGGUNA & TOKO ---

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId; 
      allow delete: if isSuperAdmin();
    }
    
    match /stores/{storeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); 
      allow update: if isStoreAdmin(storeId) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // --- ATURAN SUB-KOLEKSI TOKO ---
    // Aturan ini mengamankan SEMUA sub-koleksi di bawah sebuah toko 
    // (misal: /stores/{storeId}/products/{productId})
    match /stores/{storeId}/{subcollection}/{docId} {
        
        function isTransaction() {
            return subcollection == 'transactions';
        }

        // BACA: Semua anggota toko (admin/kasir) bisa membaca.
        allow read: if isStoreMember(storeId);
        
        // BUAT: Admin bisa membuat apa saja. Kasir HANYA bisa membuat transaksi.
        allow create: if isStoreAdmin(storeId) || isSuperAdmin() || (isTransaction() && isStoreMember(storeId));

        // UBAH: Admin bisa mengubah apa saja. Kasir HANYA bisa mengubah meja (untuk status) dan transaksi.
        allow update: if isStoreAdmin(storeId) || isSuperAdmin() || ((subcollection == 'tables' || isTransaction()) && isStoreMember(storeId));

        // HAPUS: Hanya Admin yang bisa menghapus.
        allow delete: if isStoreAdmin(storeId) || isSuperAdmin();
    }
  }
}
